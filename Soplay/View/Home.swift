//
//  Home.swift
//  Soplay
//
//  Created by saikou on 6/19/24.
//

import SwiftUI

struct Home: View {
    
    @State private var searchText:String = ""
    @State private var activeTab:Tab = .all
    @FocusState private var isSearching: Bool
    @Environment(\.colorScheme) private var scheme
    
    @Namespace private var animation
    
    var body: some View {
        ScrollView(.vertical){
            LazyVStack(spacing:15){
                DummyMessagesView()
                
            }.safeAreaPadding(15)
             .safeAreaInset(edge: .top, spacing: 0){
                 ExpandableNavigationBar()
                    
                }
             .animation(.snappy(duration: 0.3,extraBounce: 0),value: isSearching)
        }
        .scrollTargetBehavior(CustomScrollTargetBehaviour())
        .background(.gray.opacity(0.15))
            .contentMargins(.top ,190,for:.scrollIndicators)
    }
    @ViewBuilder
    func ExpandableNavigationBar(_ title: String = "Messages") -> some View {
        GeometryReader { proxy in
            let minY = proxy.frame(in: .scrollView(axis:.vertical)).minY
            let scrollViewHeight = proxy.bounds(of: .scrollView(axis: .vertical))?.height ?? 0
            let scaleProgress = minY > 0 ? 1 + (max(min(minY/scrollViewHeight,1),0) * 0.5 )  : 1
            
            let progress =  isSearching ? 1 : max(min(-minY/70, 1),0)

            VStack(spacing:10){
                Text(title).font(.largeTitle.bold())
                    .scaleEffect(scaleProgress,anchor: .topLeading)
                    .frame(maxWidth: .infinity,alignment:.leading)
                    .padding(.bottom,10)
                HStack(spacing: 12){
                    Image(systemName: "magnifyingglass").font(.title3)
                    TextField("Search Conversations", text: $searchText)
                        .focused($isSearching)
                    if isSearching  {
                        Button(action: {
                            isSearching = false
                        }, label: {
                            Image(systemName: "xmark").font(.title3)
                        })
                        .transition(.asymmetric(insertion: .push(from: .bottom), removal: .push(from: .top)))
                    }
                }
                .foregroundStyle(Color.primary)
                .padding(.vertical,10)
                .padding(.horizontal,15 - (progress * 15))
                .clipShape(.capsule)
                .frame(height: 45).background {
                    
                    RoundedRectangle(cornerRadius: 25-(progress * 25)).fill(.background)
                        .shadow(color: .gray.opacity(0.25),radius: 5,x: 0,y: 5)
                        .padding(.top,-progress * 190)
                        .padding(.bottom,-progress * 65)
                        .padding(.horizontal,-progress * 15)
                }
                ScrollView(.horizontal){
                    HStack(spacing:12){
                        ForEach(Tab.allCases,id:\.rawValue) { tab in
                            Button(action :{
                                withAnimation(.snappy){
                                    activeTab=tab
                                }
                            }){
                                Text(tab.rawValue).font(.callout)
                                    .padding(.horizontal,15).padding(.vertical,8)
                                    .foregroundStyle(activeTab==tab ? (scheme == .dark ? .black : .white ) : Color.primary)
                                    .background{
                                        
                                        if activeTab==tab {
                                            
                                            Capsule(
                                            ).fill()
                                                .matchedGeometryEffect(id: "ACTIVETAB", in: animation)
                                        }else {
                                            
                                            Capsule().fill(.background)
                                        }
                                    }
                            }.buttonStyle(.plain)
                        }
                    }
                    
                }.frame(height: 50)
            }
            .padding(.top,25)
            .offset(y:minY<0 || isSearching ? -minY : 0)
            .offset(y:-progress*65)
            .safeAreaPadding(.horizontal,15)
        }
        .frame(height:190)
        .padding(.bottom,isSearching ? -65 :0)
        .padding(.bottom,10)
        
    }

    @ViewBuilder
    func DummyMessagesView()-> some View {
        ForEach(0..<200,id: \.self){ _ in
            HStackLayout(spacing: 12){
                Circle().frame(width: 55,height: 55)
                VStack(alignment:.leading,spacing: 6 ,content:{
                    Rectangle().frame(width: 140,height: 8)
                    Rectangle().frame(height: 8)
                    Rectangle().frame(width: 80,height: 8)
                    
                    
                })
            }.foregroundStyle(.gray.opacity(0.4))
                .padding(.horizontal,5)
        }
    }

}

struct CustomScrollTargetBehaviour :ScrollTargetBehavior {

    func updateTarget(_ target: inout ScrollTarget, context: TargetContext) {
        if target.rect.minY < 70 {
            if target.rect.minY < 35 {
                target.rect.origin = .zero
            }else {
                target.rect.origin  = .init(x: 0 , y:70)
                
            }
        }
    }
}
//Expandable NavigationBar


#Preview {
    ContentView()
}
